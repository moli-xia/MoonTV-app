# MoonTV 项目迁移说明

## 项目概述

MoonTV 是一个基于 Next.js 14 构建的跨平台影视聚合播放器，支持多资源搜索、在线播放、收藏同步等功能。本文档将指导您完成项目的迁移部署。

## 技术栈

- **前端框架**: Next.js 14 (App Router)
- **UI 框架**: Tailwind CSS 3
- **开发语言**: TypeScript 4
- **播放器**: ArtPlayer + HLS.js
- **包管理器**: pnpm
- **部署方式**: Docker / Vercel / Cloudflare Pages

## 系统要求

### 基础环境
- Node.js 20.x 或更高版本
- pnpm 包管理器
- Git

### 可选环境
- Docker (用于容器化部署)
- Redis (用于数据存储，可选)

## 迁移步骤

### 1. 获取项目代码

```bash
# 克隆项目
git clone <your-repository-url>
cd moontv

# 或者直接复制现有项目文件
```

### 2. 安装依赖

```bash
# 启用 pnpm (如果未安装)
npm install -g pnpm

# 安装项目依赖
pnpm install
```

### 3. 环境配置

#### 3.1 创建环境变量文件

创建 `.env.local` 文件：

```bash
# 管理员密码 (必需)
PASSWORD=your_admin_password

# 存储类型 (可选，默认为 localstorage)
NEXT_PUBLIC_STORAGE_TYPE=localstorage

# 站点名称 (可选，默认为 MoonTV)
SITE_NAME=MoonTV

# Redis 配置 (如果使用 Redis 存储)
# UPSTASH_REDIS_REST_URL=your_redis_url
# UPSTASH_REDIS_REST_TOKEN=your_redis_token

# Cloudflare D1 配置 (如果使用 D1 存储)
# CLOUDFLARE_D1_TOKEN=your_d1_token
# CLOUDFLARE_D1_DATABASE_ID=your_database_id
```

#### 3.2 配置资源站点

编辑 `config.json` 文件，配置影视资源站点：

```json
{
  "cache_time": 7200,
  "api_site": {
    "site_key": {
      "api": "资源站API地址",
      "name": "资源站名称",
      "detail": "资源站详情页地址(可选)"
    }
  }
}
```

### 4. 部署方式选择

#### 方式一：本地开发部署

```bash
# 开发模式
pnpm dev

# 生产构建
pnpm build
pnpm start
```

#### 方式二：Docker 部署 (推荐)

```bash
# 构建 Docker 镜像
docker build -t moontv .

# 运行容器
docker run -d \
  --name moontv \
  -p 3000:3000 \
  -e PASSWORD=your_admin_password \
  -e NEXT_PUBLIC_STORAGE_TYPE=localstorage \
  -v $(pwd)/config.json:/app/config.json \
  moontv
```

#### 方式三：Docker Compose 部署

创建 `docker-compose.yml`：

```yaml
version: '3.8'
services:
  moontv:
    build: .
    ports:
      - "3000:3000"
    environment:
      - PASSWORD=your_admin_password
      - NEXT_PUBLIC_STORAGE_TYPE=localstorage
      - SITE_NAME=MoonTV
    volumes:
      - ./config.json:/app/config.json
    restart: unless-stopped

  # 可选：Redis 服务
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    restart: unless-stopped
```

运行：
```bash
docker-compose up -d
```

#### 方式四：Vercel 部署

1. Fork 项目到您的 GitHub
2. 在 Vercel 中导入项目
3. 设置环境变量：
   - `PASSWORD`: 管理员密码
   - `NEXT_PUBLIC_STORAGE_TYPE`: 存储类型
4. 部署完成

#### 方式五：Cloudflare Pages 部署

```bash
# 构建用于 Cloudflare Pages 的版本
pnpm pages:build

# 部署到 Cloudflare Pages
# 上传 out 目录到 Cloudflare Pages
```

### 5. 移动端 APP 构建 (可选)

如需构建 Android APP：

```bash
# 安装 Capacitor CLI
npm install -g @capacitor/cli

# 构建 Web 应用
pnpm build

# 同步到 Android
npx cap sync android

# 在 Android Studio 中打开项目
npx cap open android
```

## 配置说明

### 存储方式对比

| 存储方式 | Docker | Vercel | Cloudflare | 多用户支持 | 数据同步 |
|---------|--------|--------|------------|------------|----------|
| localstorage | ✅ | ✅ | ✅ | ❌ | ❌ |
| 原生 Redis | ✅ | ❌ | ❌ | ✅ | ✅ |
| Upstash Redis | ✅ | ✅ | ✅ | ✅ | ✅ |
| Cloudflare D1 | ❌ | ❌ | ✅ | ✅ | ✅ |

### 重要文件说明

- `config.json`: 资源站点配置
- `.env.local`: 环境变量配置
- `capacitor.config.ts`: 移动端配置
- `next.config.js`: Next.js 配置
- `Dockerfile`: Docker 构建配置
- `start.js`: 自定义启动脚本

## 迁移检查清单

### 迁移前准备
- [ ] 确认 Node.js 版本 (≥20.x)
- [ ] 安装 pnpm 包管理器
- [ ] 准备环境变量配置
- [ ] 确认资源站点配置

### 迁移过程
- [ ] 复制项目文件
- [ ] 安装依赖 (`pnpm install`)
- [ ] 配置环境变量 (`.env.local`)
- [ ] 配置资源站点 (`config.json`)
- [ ] 选择部署方式
- [ ] 执行部署命令

### 迁移后验证
- [ ] 访问首页正常显示
- [ ] 搜索功能正常工作
- [ ] 视频播放功能正常
- [ ] 管理员登录正常 (`/admin`)
- [ ] 移动端适配正常
- [ ] PWA 功能正常 (可安装到桌面)

## 常见问题

### Q1: 构建失败，提示依赖问题
**A**: 确保使用 pnpm 安装依赖，删除 `node_modules` 后重新安装：
```bash
rm -rf node_modules
pnpm install
```

### Q2: Docker 构建时间过长
**A**: 使用多阶段构建已优化，确保网络连接稳定，可考虑使用国内镜像源。

### Q3: 视频无法播放
**A**: 检查资源站点配置是否正确，确认网络可访问资源站点。

### Q4: 移动端全屏问题
**A**: 确保在 HTTPS 环境下使用，HTTP 环境下某些功能可能受限。

### Q5: 环境变量不生效
**A**: 
- 确认 `.env.local` 文件位于项目根目录
- 重启开发服务器
- Docker 部署时确认环境变量正确传递

## 性能优化建议

1. **启用 Redis 缓存**: 使用 Redis 存储可提升性能和支持多用户
2. **CDN 加速**: 配置 CDN 加速静态资源访问
3. **资源站点优化**: 选择稳定快速的资源站点
4. **服务器配置**: 确保服务器有足够的内存和带宽

## 安全建议

1. **修改默认密码**: 务必修改 `PASSWORD` 环境变量
2. **HTTPS 部署**: 生产环境建议使用 HTTPS
3. **防火墙配置**: 仅开放必要端口
4. **定期更新**: 保持依赖包和系统更新

## 技术支持

如遇到问题，请检查：
1. 项目日志输出
2. 浏览器控制台错误
3. 网络连接状态
4. 配置文件格式

---

**注意**: 本项目仅供学习交流使用，请遵守相关法律法规，合理使用影视资源。